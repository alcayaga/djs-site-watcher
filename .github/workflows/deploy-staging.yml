name: Deploy to Staging

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/staging'

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        DEPLOY_PATH: ${{ secrets.STAGING_DEPLOY_PATH }}
      with:
        host: home.alcayaga.net
        username: gemini-cli
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        envs: DEPLOY_PATH
        script: |
          # Ensure the script is executable (it might be new)
          # We need to find the script first. Since we haven't pulled yet in this session,
          # we rely on the script being present in the target directory from previous deploys
          # OR we need to bootstrap it.
          
          # Ideally, we cd to the path and pull.
          # Since the script now handles the pull, we need to bootstrap the script execution.
          # But we need to know WHERE to cd to.
          
          # If DEPLOY_PATH is not set in secrets yet, fail or fallback?
          # The script uses DEPLOY_PATH.
          
          TARGET="${DEPLOY_PATH:-/home/pi/staging/djs-site-watcher}"
          
          cd "$TARGET"
          
          # We need to fetch the script first if it changed?
          # Or we just run git fetch/reset manually one last time here to get the script, then run the script?
          # Or just trust the script is there?
          # If we reset hard, we get the script.
          
          git fetch origin staging
          git reset --hard origin/staging
          
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh
